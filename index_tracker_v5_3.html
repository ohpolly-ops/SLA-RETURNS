<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Unpack â†’ Return Processing Planner v5.3</title>
<style>
  :root{ --bg:#ffe6f5; --card:#fff7fb; --line:#f0cce0; --ink:#400033; }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  h1{margin:24px 20px 8px}
  .container{padding:0 20px 40px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 2px 4px rgba(0,0,0,.04)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-1{grid-column:span 1}.col-2{grid-column:span 2}.col-3{grid-column:span 3}
  .col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
  label{display:block;font-size:.85rem;color:#5a4d57;margin-bottom:4px}
  input,select,textarea{width:100%;padding:8px;border-radius:10px;border:1px solid #d9b6c8;background:#fff;color:#2b1f28}
  button{padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
  .btn{background:#d63384;color:#fff}.btn.out{background:#fff;color:#d63384;border:1px solid #d63384}
  .stack{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{background:#ffd6eb;padding:6px 10px;border-radius:16px;display:inline-flex;align-items:center;gap:8px}
  .muted{color:#6e6071;font-size:.9rem}
  .badge{padding:2px 8px;border-radius:999px;font-weight:600;font-size:.75rem}
  .b-good{background:#c6f6c6}.b-warn{background:#ffe6a6}.b-bad{background:#ffb3b3}
  table{border-collapse:collapse;width:100%;margin-top:10px}
  th,td{border:1px solid #ead0df;padding:8px;font-size:.92rem}
  th{background:#f8d6ea;text-align:left}
  .tile{background:#fff;border:1px dashed #f0cce0;border-radius:12px;padding:10px}
  .num{font-weight:700}
  .legend{font-size:.85rem;color:#5a4d57}
  .rowline{border-bottom:1px dashed #eed4e5;padding-bottom:8px;margin-bottom:8px}
  .section-totals{margin:8px 0 4px}
</style>
</head>
<body>
<h1>Unpack â†’ Return Processing Planner v5.3</h1>
<div class="container">

  <div class="card">
    <div class="stack">
      <div class="pill">Unpack target <input id="ach_unp" type="number" value="65" min="40" max="120" style="width:90px"> /h</div>
      <div class="pill">Process target <input id="ach_proc" type="number" value="28" min="15" max="80" style="width:90px"> /h</div>
      <div class="pill">Items/parcel <input id="ach_ipp" type="number" value="1.9" step="0.1" style="width:90px"></div>
    </div>
    <div class="muted" style="margin-top:6px">If unpack &lt; 65/h or process &lt; 28/h, add a reason â€” will appear in Slack summary.</div>
  </div>

  <div class="card">
    <h2>UK Couriers</h2>
    <div class="legend">SLA UK: â‰¤3d ðŸŸ¢ â€¢ â‰¤6d ðŸŸ  â€¢ &gt;6d ðŸ”´</div>

    <div class="section-totals" id="uk_totals"></div>

    <h3 style="margin:10px 0 6px">Packed backlog (pallets by courier & date)</h3>
    <div id="uk_wrap"></div>
    <button class="btn out" type="button" onclick="addRow('uk')">+ Add UK row</button>

    <h3 style="margin:16px 6px 6px">Already unpacked (parcels by date)</h3>
    <div id="uk_unp_wrap"></div>
    <button class="btn out" type="button" onclick="addRow('uk_unp')">+ Add UK unpacked row</button>

    <div class="grid" style="margin-top:12px">
      <div class="col-4 tile"><div class="muted">Oldest packed (days)</div><div class="num" id="uk_old_packed">0</div></div>
      <div class="col-4 tile"><div class="muted">Oldest unpacked (days)</div><div class="num" id="uk_old_unpacked">0</div></div>
      <div class="col-4 tile"><div class="muted">Hours required today (to Green)</div><div class="num" id="uk_hours">0.0 unp + 0.0 proc</div></div>
    </div>
  </div>

  <div class="card">
    <h2>International Couriers</h2>
    <div class="legend">SLA INT: â‰¤5d ðŸŸ¢ â€¢ â‰¤7d ðŸŸ  â€¢ &gt;8d ðŸ”´</div>

    <div class="section-totals" id="int_totals"></div>

    <h3 style="margin:10px 0 6px">Packed backlog (pallets by date)</h3>
    <div id="int_wrap"></div>
    <button class="btn out" type="button" onclick="addRow('int')">+ Add INT row</button>

    <h3 style="margin:16px 6px 6px">Already unpacked (parcels by date)</h3>
    <div id="int_unp_wrap"></div>
    <button class="btn out" type="button" onclick="addRow('int_unp')">+ Add INT unpacked row</button>

    <div class="grid" style="margin-top:12px">
      <div class="col-4 tile"><div class="muted">Oldest packed (days)</div><div class="num" id="int_old_packed">0</div></div>
      <div class="col-4 tile"><div class="muted">Oldest unpacked (days)</div><div class="num" id="int_old_unpacked">0</div></div>
      <div class="col-4 tile"><div class="muted">Hours required today (to Green)</div><div class="num" id="int_hours">0.0 unp + 0.0 proc</div></div>
    </div>
  </div>

  <div class="card">
    <h2>Special Returns (excluded)</h2>
    <div class="legend">RTS â€¢ Mexico â€¢ Axima â€” assumed 120 orders/pallet. Mexico/Axima: unpack 40/h; process 28/h. RTS: same person, 50 items/h total. Badges shown per row by date.</div>
    <div id="ret_wrap"></div>
    <button class="btn out" type="button" onclick="addRow('ret')">+ Add Return row</button>
    <div class="grid" style="margin-top:12px">
      <div class="col-4 tile"><div class="muted">Oldest (days)</div><div class="num" id="ret_old">0</div></div>
      <div class="col-8 tile"><div class="muted">Hours (Returns)</div><div class="num" id="ret_hours">0.0 unpack + 0.0 process (RTS combined within process)</div></div>
    </div>
  </div>

  <div class="card">
    <h2>Shift availability & Forecast</h2>
    <div class="grid">
      <div class="col-3">
        <label>12h shifts (eff. 11h)</label>
        <input id="n12" type="number" min="0" step="1" value="0">
      </div>
      <div class="col-3">
        <label>9h shifts (eff. 8.5h)</label>
        <input id="n9" type="number" min="0" step="1" value="0">
      </div>
      <div class="col-3">
        <label>6h shifts (eff. 5.5h)</label>
        <input id="n6" type="number" min="0" step="1" value="0">
      </div>
      <div class="col-3 tile">
        <div class="muted">Hours available</div>
        <div class="num" id="tot_avail">0.0</div>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="col-4 tile"><div class="muted">Need today (to Green)</div><div class="num" id="need_today">0 parcels to unpack â€¢ 0 items to process</div></div>
      <div class="col-4 tile"><div class="muted">Capacity with people</div><div class="num" id="cap_today">0 parcels (unpack) â€¢ 0 items (process)</div></div>
      <div class="col-4 tile"><div class="muted">Status</div><div class="num" id="status_text">â€”</div></div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div class="col-12 tile"><div class="muted">OT to keep UK &amp; fix INT</div><div class="num" id="ot_keep">0.0</div></div>
    </div>

    <div class="muted" id="summary_note" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h2>Minimum headcount per stream</h2>
    <table id="min_table"><thead><tr><th>Stream</th><th>Min People</th><th>Time left (h)</th><th>Status</th></tr></thead><tbody></tbody></table>
    <h2 style="margin-top:16px">Suggested split</h2>
    <table id="split_table"><thead><tr><th>Stream</th><th>People</th><th>Hours</th><th>Status</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <button class="btn" onclick="copySlack()">Copy Slack summary</button>
  </div>

</div>

<!-- Reason modal -->
<div id="reason_modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:50">
  <div class="card" style="max-width:520px;width:92%;background:#fff7fb">
    <h3>Reason required</h3>
    <div class="muted">Please explain why achievable target is lower than threshold.</div>
    <textarea id="reason_text"></textarea>
    <div class="stack" style="justify-content:flex-end;margin-top:8px">
      <button class="btn out" onclick="closeReason()">Cancel</button>
      <button class="btn" onclick="saveReason()">Save</button>
    </div>
  </div>
</div>

<script>
const SLA={UK:{green:3,amber:6,red:6},INT:{green:5,amber:7,red:8}};
const PPL_UK_INT=140;
const PPL_RET=120; // orders per pallet
const MEX_UNP_RATE=40; // parcels/orders per hour
const RTS_COMBINED_RATE=50; // items per hour combined
let UNP_RATE=65,PROC_RATE=28,IPP=1.9;
let pendingType=null;

function badgeFor(dateStr, region){
  const age=daysBetween(dateStr);
  const [bc,tt,ico]=band(age,region);
  return `<span class="badge ${bc}">${tt}</span>`;
}

function addRow(type){
  const wrap=document.getElementById(type+'_wrap');
  const row=document.createElement('div');
  row.className='grid rowline';
  let content='';
  if(type==='uk'){
    content = `
      <div class="col-3">
        <label>Courier</label>
        <select class="uk_courier"><option>ASDA</option><option>EVRI</option><option>INPOST</option></select>
      </div>
      <div class="col-4">
        <label>Date</label>
        <input type="date" class="uk_date" oninput="this.nextElementSibling.innerHTML = badgeFor(this.value,'UK')">
        <div class="muted">${badgeFor('', 'UK')}</div>
      </div>
      <div class="col-4">
        <label>Pallets</label>
        <input type="number" min="0" step="1" class="uk_pallets">
      </div>
      <div class="col-1" style="display:flex;align-items:end">
        <button class="btn out" type="button" onclick="this.closest('.grid').remove();render()">Ã—</button>
      </div>`;
  } else if(type==='uk_unp'){
    content = `
      <div class="col-5">
        <label>Date (unpacked)</label>
        <input type="date" class="uk_unp_date" oninput="this.nextElementSibling.innerHTML = badgeFor(this.value,'UK')">
        <div class="muted">${badgeFor('', 'UK')}</div>
      </div>
      <div class="col-6">
        <label>Parcels already unpacked</label>
        <input type="number" min="0" step="1" class="uk_unp_parcels">
      </div>
      <div class="col-1" style="display:flex;align-items:end">
        <button class="btn out" type="button" onclick="this.closest('.grid').remove();render()">Ã—</button>
      </div>`;
  } else if(type==='int'){
    content = `
      <div class="col-5">
        <label>Date</label>
        <input type="date" class="int_date" oninput="this.nextElementSibling.innerHTML = badgeFor(this.value,'INT')">
        <div class="muted">${badgeFor('', 'INT')}</div>
      </div>
      <div class="col-6">
        <label>Pallets</label>
        <input type="number" min="0" step="1" class="int_pallets">
      </div>
      <div class="col-1" style="display:flex;align-items:end">
        <button class="btn out" type="button" onclick="this.closest('.grid').remove();render()">Ã—</button>
      </div>`;
  } else if(type==='int_unp'){
    content = `
      <div class="col-5">
        <label>Date (unpacked)</label>
        <input type="date" class="int_unp_date" oninput="this.nextElementSibling.innerHTML = badgeFor(this.value,'INT')">
        <div class="muted">${badgeFor('', 'INT')}</div>
      </div>
      <div class="col-6">
        <label>Parcels already unpacked</label>
        <input type="number" min="0" step="1" class="int_unp_parcels">
      </div>
      <div class="col-1" style="display:flex;align-items:end">
        <button class="btn out" type="button" onclick="this.closest('.grid').remove();render()">Ã—</button>
      </div>`;
  } else if(type==='ret'){
    content = `
      <div class="col-3">
        <label>Type</label>
        <select class="ret_courier"><option>RTS</option><option>MEXICO</option><option>AXIMA</option></select>
      </div>
      <div class="col-4">
        <label>Date</label>
        <input type="date" class="ret_date" oninput="this.nextElementSibling.innerHTML = badgeFor(this.value,'INT')">
        <div class="muted">${badgeFor('', 'INT')}</div>
      </div>
      <div class="col-4">
        <label>Pallets</label>
        <input type="number" min="0" step="1" class="ret_pallets">
      </div>
      <div class="col-1" style="display:flex;align-items:end">
        <button class="btn out" type="button" onclick="this.closest('.grid').remove();render()">Ã—</button>
      </div>`;
  }
  row.innerHTML = content;
  wrap.appendChild(row);
  row.querySelectorAll('input,select').forEach(el=>el.addEventListener('input',render));
  render();
}

function openReason(which){pendingType=which;document.getElementById('reason_modal').style.display='flex';}
function closeReason(){document.getElementById('reason_modal').style.display='none';}
function saveReason(){
  const txt=document.getElementById('reason_text').value.trim();
  if(pendingType==='unp') window._reason_unp=txt;
  if(pendingType==='proc') window._reason_proc=txt;
  closeReason(); render();
}

function daysBetween(d){
  if(!d) return 0;
  const dt=new Date(d); const now=new Date();
  return Math.floor((now - dt)/(1000*60*60*24));
}
function band(age,region){
  const thr=region==='UK'?SLA.UK:SLA.INT;
  if(age>thr.red) return ['b-bad','Red','ðŸ”´'];
  if(age>thr.green) return ['b-warn','Amber','ðŸŸ '];
  return ['b-good','Green','ðŸŸ¢'];
}
function timeLeftHours(age,region){
  const g=region==='UK'?SLA.UK.green:SLA.INT.green;
  return Math.max(0,g*24 - age*24);
}
function fmt(n){return (Math.round(n*10)/10).toFixed(1)}

function sumBy(arr,fn){return arr.reduce((a,x)=>a+fn(x),0);}

function computeToGreenPacked(rows, greenDays){
  // rows: [{age, pallets}], return pallets that must be cleared today to bring oldest <= greenDays
  const older = rows.filter(r=>r.age>greenDays).sort((a,b)=>b.age-a.age);
  return sumBy(older, r=>r.pallets);
}
function computeToGreenUnpacked(rows, greenDays){
  // rows: [{age, parcels}], return parcels to process today
  const older = rows.filter(r=>r.age>greenDays);
  return sumBy(older, r=>r.parcels);
}

function render(){
  UNP_RATE=+document.getElementById('ach_unp').value||65;
  PROC_RATE=+document.getElementById('ach_proc').value||28;
  IPP=+document.getElementById('ach_ipp').value||1.9;

  // === UK packed rows (group per courier for totals & ages) ===
  let ukPackedRows=[]; // [{courier, age, pallets}]
  document.querySelectorAll('#uk_wrap .grid').forEach(r=>{
    const c=r.querySelector('.uk_courier')?.value||'ASDA';
    const d=r.querySelector('.uk_date')?.value; const p=+r.querySelector('.uk_pallets')?.value||0;
    const age=d?daysBetween(d):0;
    ukPackedRows.push({courier:c, age, pallets:p});
  });
  // per courier totals (packed)
  const couriers=['ASDA','EVRI','INPOST'];
  const ukPackedParByCourier = {};
  couriers.forEach(c=> ukPackedParByCourier[c] = sumBy(ukPackedRows.filter(r=>r.courier===c), r=>r.pallets)*PPL_UK_INT );
  // UK unpacked rows
  let ukUnpRows=[]; // [{age, parcels}]
  document.querySelectorAll('#uk_unp_wrap .grid').forEach(r=>{
    const d=r.querySelector('.uk_unp_date')?.value; const n=+r.querySelector('.uk_unp_parcels')?.value||0;
    const age=d?daysBetween(d):0;
    ukUnpRows.push({age, parcels:n});
  });
  // UK totals for section header
  const ukPackedParTotal = sumBy(ukPackedRows, r=>r.pallets)*PPL_UK_INT;
  const ukPackedItemsTotal = ukPackedParTotal*IPP;
  const ukUnpParTotal = sumBy(ukUnpRows, r=>r.parcels);
  const ukUnpItemsTotal = ukUnpParTotal*IPP;

  // === INT packed/unpacked ===
  let intPackedRows=[]; // [{age, pallets}]
  document.querySelectorAll('#int_wrap .grid').forEach(r=>{
    const d=r.querySelector('.int_date')?.value; const p=+r.querySelector('.int_pallets')?.value||0;
    const age=d?daysBetween(d):0;
    intPackedRows.push({age, pallets:p});
  });
  let intUnpRows=[]; // [{age, parcels}]
  document.querySelectorAll('#int_unp_wrap .grid').forEach(r=>{
    const d=r.querySelector('.int_unp_date')?.value; const n=+r.querySelector('.int_unp_parcels')?.value||0;
    const age=d?daysBetween(d):0;
    intUnpRows.push({age, parcels:n});
  });
  const intPackedParTotal = sumBy(intPackedRows, r=>r.pallets)*PPL_UK_INT;
  const intPackedItemsTotal = intPackedParTotal*IPP;
  const intUnpParTotal = sumBy(intUnpRows, r=>r.parcels);
  const intUnpItemsTotal = intUnpParTotal*IPP;

  // === Section headers (UK per courier + unpacked) ===
  const ukTotalsEl = document.getElementById('uk_totals');
  const ukLines = [
    `Packed parcels â€” ASDA ${ukPackedParByCourier.ASDA||0}, EVRI ${ukPackedParByCourier.EVRI||0}, INPOST ${ukPackedParByCourier.INPOST||0}`,
    `Packed items â€” ASDA ${(ukPackedParByCourier.ASDA*IPP||0).toFixed(0)}, EVRI ${(ukPackedParByCourier.EVRI*IPP||0).toFixed(0)}, INPOST ${(ukPackedParByCourier.INPOST*IPP||0).toFixed(0)}`,
    `Unpacked (UK): ${ukUnpParTotal} parcels â€¢ ${(ukUnpItemsTotal).toFixed(0)} items`
  ];
  ukTotalsEl.textContent = ukLines.join('  |  ');

  const intTotalsEl = document.getElementById('int_totals');
  intTotalsEl.textContent = `Packed: ${intPackedParTotal} parcels â€¢ ${intPackedItemsTotal.toFixed(0)} items  |  Unpacked: ${intUnpParTotal} parcels â€¢ ${intUnpItemsTotal.toFixed(0)} items`;

  // === Oldest ages ===
  const ukOldPacked = ukPackedRows.length? Math.max(...ukPackedRows.map(r=>r.age)):0;
  const ukOldUnp = ukUnpRows.length? Math.max(...ukUnpRows.map(r=>r.age)):0;
  const intOldPacked = intPackedRows.length? Math.max(...intPackedRows.map(r=>r.age)):0;
  const intOldUnp = intUnpRows.length? Math.max(...intUnpRows.map(r=>r.age)):0;
  document.getElementById('uk_old_packed').textContent = ukOldPacked;
  document.getElementById('uk_old_unpacked').textContent = ukOldUnp;
  document.getElementById('int_old_packed').textContent = intOldPacked;
  document.getElementById('int_old_unpacked').textContent = intOldUnp;

  // === To Green today ===
  const ukToGreenPal = computeToGreenPacked(ukPackedRows, SLA.UK.green);
  const ukToGreenPar = ukToGreenPal * PPL_UK_INT;
  const ukToGreenUnpPar = computeToGreenUnpacked(ukUnpRows, SLA.UK.green);
  const ukToGreenProcItems = ukToGreenUnpPar * IPP;

  const intToGreenPal = computeToGreenPacked(intPackedRows, SLA.INT.green);
  const intToGreenPar = intToGreenPal * PPL_UK_INT;
  const intToGreenUnpPar = computeToGreenUnpacked(intUnpRows, SLA.INT.green);
  const intToGreenProcItems = intToGreenUnpPar * IPP;

  // Hours required today (to Green)
  const ukUnpH = ukToGreenPar/UNP_RATE;
  const ukProcH = ukToGreenProcItems/PROC_RATE;
  const intUnpH = intToGreenPar/UNP_RATE;
  const intProcH = intToGreenProcItems/PROC_RATE;

  document.getElementById('uk_hours').textContent = fmt(ukUnpH)+' unp + '+fmt(ukProcH)+' proc';
  document.getElementById('int_hours').textContent = fmt(intUnpH)+' unp + '+fmt(intProcH)+' proc';

  // === Returns hours (unchanged logic) ===
  let retOld=0; let retRows=[];
  let retUnpH=0, retProcH=0, retParTotal=0, retItemsTotal=0;
  document.querySelectorAll('#ret_wrap .grid').forEach(r=>{
    const c=r.querySelector('.ret_courier')?.value||'RTS';
    const d=r.querySelector('.ret_date')?.value; const p=+r.querySelector('.ret_pallets')?.value||0;
    const age=d?daysBetween(d):0;
    retRows.push([c,d,p]); if(d){retOld=Math.max(retOld,age);}
    const orders = p*PPL_RET; retParTotal += orders; retItemsTotal += orders; // orders=items
    if(c==='MEXICO' || c==='AXIMA'){
      retUnpH += orders / MEX_UNP_RATE;
      retProcH += orders / PROC_RATE; // assume 28/h
    } else if(c==='RTS'){
      retProcH += orders / RTS_COMBINED_RATE; // combined
    }
  });
  document.getElementById('ret_old').textContent = retOld;
  document.getElementById('ret_hours').textContent = fmt(retUnpH)+' unpack + '+fmt(retProcH)+' process (RTS combined within process)';

  // === Availability & Forecast ===
  const n12=+document.getElementById('n12').value||0;
  const n9 =+document.getElementById('n9').value||0;
  const n6 =+document.getElementById('n6').value||0;
  const avail = n12*11 + n9*8.5 + n6*5.5;
  document.getElementById('tot_avail').textContent = fmt(avail);

  const needParToday = ukToGreenPar + intToGreenPar;
  const needItemsToday = ukToGreenProcItems + intToGreenProcItems;
  document.getElementById('need_today').textContent = `${needParToday} parcels to unpack â€¢ ${needItemsToday.toFixed(0)} items to process`;

  const capPar = avail * UNP_RATE;
  const capItems = avail * PROC_RATE;
  document.getElementById('cap_today').textContent = `${Math.floor(capPar)} parcels (unpack) â€¢ ${Math.floor(capItems)} items (process)`;

  const feasible = (capPar>=needParToday) && (capItems>=needItemsToday);
  document.getElementById('status_text').textContent = feasible?'OK':'Short';

  // === OT helper as before (region-aware, based on hours to Green)
  const streams=[
    {key:'UK-Unpack',region:'UK',h:ukUnpH,age:ukOldPacked},
    {key:'UK-Process',region:'UK',h:ukProcH,age:Math.max(ukOldUnp,ukOldPacked)},
    {key:'INT-Unpack',region:'INT',h:intUnpH,age:intOldPacked},
    {key:'INT-Process',region:'INT',h:intProcH,age:Math.max(intOldUnp,intOldPacked)},
  ];
  const totalPeople = n12+n9+n6;
  const minUK = streams.filter(s=>s.region==='UK').reduce((a,s)=>{
    const tl=timeLeftHours(s.age,'UK'); const minP = tl>0?Math.ceil(s.h/Math.max(0.1,tl)):Math.ceil(s.h/11);
    return a+minP;
  },0);
  const capAfterUK = Math.max(0, totalPeople - minUK);
  const needINT = streams.filter(s=>s.region==='INT').reduce((a,s)=>{
    const tl=timeLeftHours(s.age,'INT'); const minP = tl>0?Math.ceil(s.h/Math.max(0.1,tl)):Math.ceil(s.h/11);
    return a+minP;
  },0);
  const pplShort = Math.max(0, needINT - capAfterUK);
  const otKeep = pplShort * 11;
  document.getElementById('ot_keep').textContent = fmt(otKeep);

  // === Tables (to Green hours basis) ===
  const minT=document.querySelector('#min_table tbody');
  const splitT=document.querySelector('#split_table tbody');
  minT.innerHTML=''; splitT.innerHTML='';
  streams.forEach(s=>{
    const tl=timeLeftHours(s.age,s.region);
    const minP = tl>0?Math.ceil(s.h/Math.max(0.1,tl)):Math.ceil(s.h/11);
    const [bc,tt,ico]=band(s.age,s.region);
    const tr1=document.createElement('tr');
    tr1.innerHTML=`<td>${s.key}</td><td>${minP}</td><td>${fmt(tl)}</td><td><span class="badge ${bc}">${tt}</span></td>`;
    minT.appendChild(tr1);
    const tr2=document.createElement('tr');
    tr2.innerHTML=`<td>${s.key}</td><td>${minP}</td><td>${fmt(s.h)}</td><td><span class="badge ${bc}">${tt}</span></td>`;
    splitT.appendChild(tr2);
  });

  // bottom note
  const [bU, tU]=band(Math.max(ukOldPacked,ukOldUnp),'UK');
  const [bI, tI]=band(Math.max(intOldPacked,intOldUnp),'INT');
  document.getElementById('summary_note').textContent = `Today we only target what is needed to stay Green (UK â‰¤3d, INT â‰¤5d). With ${fmt(avail)} h available, you can do ~${Math.floor(capPar)} parcels and ~${Math.floor(capItems)} items. Need today: ${needParToday} parcels & ${needItemsToday.toFixed(0)} items. Status: ${feasible?'OK':'SHORT'}.`;

  // Store for Slack
  window._UK={packedRows:ukPackedRows,unpRows:ukUnpRows,oldPacked:ukOldPacked,oldUnp:ukOldUnp,packedParTotal:ukPackedParTotal,packedItemsTotal:ukPackedItemsTotal,unpParTotal:ukUnpParTotal,unpItemsTotal:ukUnpItemsTotal, toGreenPar:ukToGreenPar, toGreenItems:ukToGreenProcItems};
  window._INT={packedRows:intPackedRows,unpRows:intUnpRows,oldPacked:intOldPacked,oldUnp:intOldUnp,packedParTotal:intPackedParTotal,packedItemsTotal:intPackedItemsTotal,unpParTotal:intUnpParTotal,unpItemsTotal:intUnpItemsTotal, toGreenPar:intToGreenPar, toGreenItems:intToGreenProcItems};
  window._RET={rows:retRows,old:retOld,retUnpH,retProcH,retParTotal,retItemsTotal};
  window._CAP={avail,capPar,capItems,needParToday,needItemsToday,otKeep};
}

function copySlack(){
  const achUnp=+document.getElementById('ach_unp').value;
  const achProc=+document.getElementById('ach_proc').value;
  let lines=['*Unpack â†’ Return Processing Planner v5.3*'];
  if(achUnp<65) lines.push(`Unpack target ${achUnp}/h â€” reason: ${window._reason_unp||'N/A'}`);
  if(achProc<28) lines.push(`Process target ${achProc}/h â€” reason: ${window._reason_proc||'N/A'}`);

  lines.push('\n*UK*');
  const uk=window._UK;
  uk.packedRows.forEach(r=>lines.push(`${r.courier} â€” ${r.pallets} pallets (age ${r.age}d)`));
  uk.unpRows.forEach(r=>lines.push(`Unpacked â€” ${r.parcels} parcels (age ${r.age}d)`));
  lines.push(`Totals: Packed ${uk.packedParTotal} parcels / ${uk.packedItemsTotal.toFixed(0)} items | Unpacked ${uk.unpParTotal} parcels / ${uk.unpItemsTotal.toFixed(0)} items`);
  lines.push(`Need to Green today: ${uk.toGreenPar} parcels to unpack â€¢ ${uk.toGreenItems.toFixed(0)} items to process`);

  lines.push('\n*International*');
  const it=window._INT;
  it.packedRows.forEach(r=>lines.push(`INT â€” ${r.pallets} pallets (age ${r.age}d)`));
  it.unpRows.forEach(r=>lines.push(`Unpacked â€” ${r.parcels} parcels (age ${r.age}d)`));
  lines.push(`Totals: Packed ${it.packedParTotal} parcels / ${it.packedItemsTotal.toFixed(0)} items | Unpacked ${it.unpParTotal} parcels / ${it.unpItemsTotal.toFixed(0)} items`);
  lines.push(`Need to Green today: ${it.toGreenPar} parcels to unpack â€¢ ${it.toGreenItems.toFixed(0)} items to process`);

  lines.push('\n*Special Returns* (excluded)');
  const rt=window._RET;
  rt.rows.forEach(r=>lines.push(`${r[0]} â€” ${r[2]} pallets`));
  lines.push(`Hours: ${rt.retUnpH.toFixed(1)} unpack + ${rt.retProcH.toFixed(1)} process`);

  const C=window._CAP;
  lines.push('\n*Capacity & OT*');
  lines.push(`Capacity with people: ~${Math.floor(C.capPar)} parcels unpack â€¢ ~${Math.floor(C.capItems)} items process (from ${C.avail.toFixed(1)} h)`);
  lines.push(`Need today: ${C.needParToday} parcels â€¢ ${C.needItemsToday.toFixed(0)} items`);
  lines.push(`OT to keep UK & fix INT: ~${C.otKeep.toFixed(1)} h`);

  navigator.clipboard.writeText(lines.join('\n')).then(()=>alert('Copied to clipboard'));
}

document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('ach_unp').addEventListener('change',e=>{ if(+e.target.value<65 && !window._reason_unp) openReason('unp'); });
  document.getElementById('ach_proc').addEventListener('change',e=>{ if(+e.target.value<28 && !window._reason_proc) openReason('proc'); });
  ['n12','n9','n6'].forEach(id=>document.getElementById(id).addEventListener('input',render));
  // default rows
  addRow('uk'); addRow('uk_unp');
  addRow('int'); addRow('int_unp');
  addRow('ret');
  render();
});
</script>
</body>
</html>